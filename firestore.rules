rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regra para dados de usuário: um usuário só pode ler e escrever em seus próprios documentos.
    match /users/{userId}/{documents=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Nova regra para arquivamento: permite que um usuário crie um documento em 'archived_chats'.
    // A segurança é garantida ao verificar se o ID do usuário que está fazendo a requisição
    // é o mesmo que está sendo salvo no campo 'deletedBy' do documento de arquivamento.
    match /archived_chats/{chatId} {
      allow create: if request.auth != null && request.auth.uid == request.resource.data.deletedBy;
      
      // Nega a leitura, atualização ou exclusão de chats arquivados pelo cliente para segurança.
      allow read, update, delete: if false;
    }
    
    // Nega acesso a qualquer outra coleção na raiz por padrão.
  }
}
